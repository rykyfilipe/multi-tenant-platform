{
  "info": {
    "name": "ANAF e-Factura Integration",
    "description": "Complete ANAF e-Factura integration testing collection",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{access_token}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "base_url",
      "value": "https://api.anaf.ro/prod/FCTEL/rest",
      "type": "string"
    },
    {
      "key": "oauth_url",
      "value": "https://logincert.anaf.ro/anaf-oauth2/v1",
      "type": "string"
    },
    {
      "key": "client_id",
      "value": "{{ANAF_CLIENT_ID}}",
      "type": "string"
    },
    {
      "key": "client_secret",
      "value": "{{ANAF_CLIENT_SECRET}}",
      "type": "string"
    },
    {
      "key": "redirect_uri",
      "value": "{{ANAF_REDIRECT_URI}}",
      "type": "string"
    },
    {
      "key": "access_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "refresh_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "authorization_code",
      "value": "",
      "type": "string"
    },
    {
      "key": "submission_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "invoice_xml",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "OAuth2 Flow",
      "item": [
        {
          "name": "1. Get Authorization URL",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{oauth_url}}/authorize?response_type=code&client_id={{client_id}}&redirect_uri={{redirect_uri}}&state=xyz&token_content_type=jwt",
              "host": ["{{oauth_url}}"],
              "path": ["authorize"],
              "query": [
                {"key": "response_type", "value": "code"},
                {"key": "client_id", "value": "{{client_id}}"},
                {"key": "redirect_uri", "value": "{{redirect_uri}}"},
                {"key": "state", "value": "xyz"},
                {"key": "token_content_type", "value": "jwt"}
              ]
            },
            "description": "Get OAuth2 authorization URL for ANAF e-Factura"
          },
          "response": []
        },
        {
          "name": "2. Exchange Code for Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('access_token', response.access_token);",
                  "    pm.collectionVariables.set('refresh_token', response.refresh_token);",
                  "    console.log('Access token saved:', response.access_token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "grant_type", "value": "authorization_code"},
                {"key": "client_id", "value": "{{client_id}}"},
                {"key": "client_secret", "value": "{{client_secret}}"},
                {"key": "code", "value": "{{authorization_code}}"},
                {"key": "redirect_uri", "value": "{{redirect_uri}}"},
                {"key": "token_content_type", "value": "jwt"}
              ]
            },
            "url": {
              "raw": "{{oauth_url}}/token",
              "host": ["{{oauth_url}}"],
              "path": ["token"]
            },
            "description": "Exchange authorization code for access token"
          },
          "response": []
        },
        {
          "name": "3. Refresh Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('access_token', response.access_token);",
                  "    pm.collectionVariables.set('refresh_token', response.refresh_token);",
                  "    console.log('Token refreshed:', response.access_token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/x-www-form-urlencoded"
              }
            ],
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {"key": "grant_type", "value": "refresh_token"},
                {"key": "client_id", "value": "{{client_id}}"},
                {"key": "client_secret", "value": "{{client_secret}}"},
                {"key": "refresh_token", "value": "{{refresh_token}}"},
                {"key": "token_content_type", "value": "jwt"}
              ]
            },
            "url": {
              "raw": "{{oauth_url}}/token",
              "host": ["{{oauth_url}}"],
              "path": ["token"]
            },
            "description": "Refresh access token using refresh token"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Invoice Management",
      "item": [
        {
          "name": "1. Generate Test XML",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('invoice_xml', response.xml);",
                  "    console.log('XML generated and saved');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"testType\": \"xml\",\n  \"tenantId\": 1\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/test-anaf",
              "host": ["{{base_url}}"],
              "path": ["api", "test-anaf"]
            },
            "description": "Generate test XML for ANAF submission"
          },
          "response": []
        },
        {
          "name": "2. Submit Invoice to ANAF",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('submission_id', response.submissionId);",
                  "    console.log('Invoice submitted, ID:', response.submissionId);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/xml; charset=utf-8"
              },
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "User-Agent",
                "value": "MultiTenantPlatform/1.0"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{{invoice_xml}}"
            },
            "url": {
              "raw": "{{base_url}}/upload",
              "host": ["{{base_url}}"],
              "path": ["upload"]
            },
            "description": "Submit invoice XML to ANAF e-Factura"
          },
          "response": []
        },
        {
          "name": "3. Check Invoice Status",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/status/{{submission_id}}",
              "host": ["{{base_url}}"],
              "path": ["status", "{{submission_id}}"]
            },
            "description": "Check the status of submitted invoice"
          },
          "response": []
        },
        {
          "name": "4. Download Response",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Accept",
                "value": "application/xml"
              }
            ],
            "url": {
              "raw": "{{base_url}}/download/{{submission_id}}",
              "host": ["{{base_url}}"],
              "path": ["download", "{{submission_id}}"]
            },
            "description": "Download ANAF response for submitted invoice"
          },
          "response": []
        }
      ]
    },
    {
      "name": "API Testing",
      "item": [
        {
          "name": "1. Test ANAF API Connection",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/hello?name=Test",
              "host": ["{{base_url}}"],
              "path": ["hello"],
              "query": [
                {"key": "name", "value": "Test"}
              ]
            },
            "description": "Test basic ANAF API connection"
          },
          "response": []
        },
        {
          "name": "2. Validate XML Structure",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"xml\": \"{{invoice_xml}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/test-anaf/validate-xml",
              "host": ["{{base_url}}"],
              "path": ["api", "test-anaf", "validate-xml"]
            },
            "description": "Validate XML structure against EN16931 schema"
          },
          "response": []
        }
      ]
    },
    {
      "name": "Error Handling",
      "item": [
        {
          "name": "1. Test Invalid Token",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer invalid_token"
              }
            ],
            "url": {
              "raw": "{{base_url}}/status/test",
              "host": ["{{base_url}}"],
              "path": ["status", "test"]
            },
            "description": "Test error handling with invalid token"
          },
          "response": []
        },
        {
          "name": "2. Test Invalid XML",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              },
              {
                "key": "Content-Type",
                "value": "application/xml"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "<invalid>xml</invalid>"
            },
            "url": {
              "raw": "{{base_url}}/upload",
              "host": ["{{base_url}}"],
              "path": ["upload"]
            },
            "description": "Test error handling with invalid XML"
          },
          "response": []
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Set default values if not already set",
          "if (!pm.collectionVariables.get('base_url')) {",
          "    pm.collectionVariables.set('base_url', 'https://api.anaf.ro/prod/FCTEL/rest');",
          "}",
          "if (!pm.collectionVariables.get('oauth_url')) {",
          "    pm.collectionVariables.set('oauth_url', 'https://logincert.anaf.ro/anaf-oauth2/v1');",
          "}"
        ]
      }
    }
  ]
}
