#!/usr/bin/env node

/**
 * ANAF e-Factura Integrated Test System
 * 
 * Acest test integrat folose»ôte serviciile reale din aplica»õie pentru a:
 * - Preia o facturƒÉ realƒÉ din baza de date (tabelul invoices)
 * - GenereazƒÉ XML-ul folosind ANAFXMLGenerator din aplica»õie
 * - Trimite factura folosind ANAFIntegration din aplica»õie
 * - VerificƒÉ rƒÉspunsul ANAF »ôi statusul
 * 
 * Usage:
 *   node tests/anaf-e-factura-integrated-test.js
 *   npm run test:anaf-e-factura-integrated
 */

const fs = require('fs').promises;
const path = require('path');

// Import serviciile din aplica»õie
const { PrismaClient } = require('@prisma/client');
const { ANAFIntegration } = require('../src/lib/anaf/anaf-integration');
const { ANAFXMLGenerator } = require('../src/lib/anaf/xml-generator');
const { ANAFOAuthService } = require('../src/lib/anaf/oauth-service');

// Configura»õie test
const TEST_CONFIG = {
  // ID-ul tenantului pentru test
  TEST_TENANT_ID: 1,
  
  // ID-ul facturii pentru test (sau null pentru a lua prima facturƒÉ)
  TEST_INVOICE_ID: null,
  
  // Rezultate test
  RESULTS_DIR: './test-results/anaf-e-factura-integrated',
  REPORT_FILE: 'anaf-integrated-test-report.json'
};

/**
 * Test Runner Integrat
 * Folose»ôte serviciile reale din aplica»õie
 */
class ANAFIntegratedTestRunner {
  constructor() {
    this.prisma = new PrismaClient();
    this.anafIntegration = new ANAFIntegration();
    this.anafOAuth = new ANAFOAuthService();
    this.reportGenerator = new TestReportGenerator();
  }

  /**
   * RuleazƒÉ toate testele integrate
   */
  async runAllTests() {
    console.log('üöÄ Pornire Test Suite ANAF e-Factura Integrat');
    console.log('='.repeat(60));
    
    try {
      // Pasul 1: VerificƒÉ conexiunea la baza de date
      await this.testDatabaseConnection();
      
      // Pasul 2: Preia factura din baza de date
      const invoice = await this.getTestInvoice();
      
      if (!invoice) {
        throw new Error('Nu s-a gƒÉsit nicio facturƒÉ pentru test');
      }
      
      // Pasul 3: GenereazƒÉ XML-ul folosind serviciile din aplica»õie
      await this.testXMLGeneration(invoice);
      
      // Pasul 4: TesteazƒÉ autentificarea ANAF
      await this.testANAFAuthentication();
      
      // Pasul 5: Trimite factura la ANAF
      await this.testInvoiceSubmission(invoice);
      
      // Pasul 6: VerificƒÉ statusul
      await this.testStatusChecking(invoice);
      
      // Pasul 7: GenereazƒÉ rapoarte
      await this.generateReports();
      
    } catch (error) {
      console.error('üí• Test suite a e»ôuat:', error.message);
      this.reportGenerator.addTestResult('Test Suite Execution', false, { error: error.message });
    } finally {
      // √énchide conexiunea la baza de date
      await this.prisma.$disconnect();
    }
  }

  /**
   * TesteazƒÉ conexiunea la baza de date
   */
  async testDatabaseConnection() {
    console.log('\nüóÑÔ∏è  Testare conexiune bazƒÉ de date...');
    
    try {
      // TesteazƒÉ conexiunea prin query simplu
      await this.prisma.$queryRaw`SELECT 1`;
      
      this.reportGenerator.addTestResult('Database Connection', true, {
        message: 'Conexiunea la baza de date func»õioneazƒÉ'
      });
      
      console.log('‚úÖ Conexiunea la baza de date func»õioneazƒÉ');
      
    } catch (error) {
      this.reportGenerator.addTestResult('Database Connection', false, { error: error.message });
      console.error('‚ùå Eroare conexiune bazƒÉ de date:', error.message);
      throw error;
    }
  }

  /**
   * Preia o facturƒÉ din baza de date pentru test
   */
  async getTestInvoice() {
    console.log('\nüìÑ Preia facturƒÉ din baza de date...');
    
    try {
      let invoice;
      
      if (TEST_CONFIG.TEST_INVOICE_ID) {
        // Preia factura specificatƒÉ
        invoice = await this.prisma.invoice.findUnique({
          where: { id: TEST_CONFIG.TEST_INVOICE_ID },
          include: {
            tenant: true,
            items: true
          }
        });
      } else {
        // Preia prima facturƒÉ disponibilƒÉ
        invoice = await this.prisma.invoice.findFirst({
          where: {
            tenantId: TEST_CONFIG.TEST_TENANT_ID
          },
          include: {
            tenant: true,
            items: true
          }
        });
      }
      
      if (!invoice) {
        throw new Error('Nu s-a gƒÉsit nicio facturƒÉ √Æn baza de date');
      }
      
      console.log(`‚úÖ FacturƒÉ gƒÉsitƒÉ: ${invoice.invoice_number || invoice.id}`);
      console.log(`   Tenant: ${invoice.tenant?.name || 'N/A'}`);
      console.log(`   Suma totalƒÉ: ${invoice.total_amount || 0} ${invoice.currency || 'RON'}`);
      console.log(`   Status: ${invoice.status || 'N/A'}`);
      console.log(`   Items: ${invoice.items?.length || 0}`);
      
      this.reportGenerator.addTestResult('Get Test Invoice', true, {
        invoiceId: invoice.id,
        invoiceNumber: invoice.invoice_number,
        tenantName: invoice.tenant?.name,
        totalAmount: invoice.total_amount,
        currency: invoice.currency,
        status: invoice.status,
        itemsCount: invoice.items?.length || 0
      });
      
      return invoice;
      
    } catch (error) {
      this.reportGenerator.addTestResult('Get Test Invoice', false, { error: error.message });
      console.error('‚ùå Eroare la preluarea facturii:', error.message);
      throw error;
    }
  }

  /**
   * TesteazƒÉ generarea XML-ului folosind serviciile din aplica»õie
   */
  async testXMLGeneration(invoice) {
    console.log('\nüîß Testare generare XML cu serviciile din aplica»õie...');
    
    try {
      // PregƒÉte»ôte datele pentru XML generator
      const invoiceData = await this.prepareInvoiceDataForXML(invoice);
      
      // GenereazƒÉ XML-ul folosind ANAFXMLGenerator
      const xmlContent = await ANAFXMLGenerator.generateXML(invoiceData);
      
      // ValideazƒÉ XML-ul
      const validationResult = ANAFXMLGenerator.validateXML(xmlContent);
      
      if (!validationResult.isValid) {
        throw new Error(`XML invalid: ${validationResult.errors.join(', ')}`);
      }
      
      console.log('‚úÖ XML generat cu succes');
      console.log(`   Dimensiune: ${xmlContent.length} caractere`);
      console.log(`   Validare: ${validationResult.isValid ? 'Valid' : 'Invalid'}`);
      
      // SalveazƒÉ XML-ul pentru inspec»õie
      await this.saveXMLForInspection(xmlContent, invoice);
      
      this.reportGenerator.addTestResult('XML Generation', true, {
        xmlSize: xmlContent.length,
        validation: validationResult.isValid,
        errors: validationResult.errors
      });
      
      // StocheazƒÉ XML-ul pentru urmƒÉtorul pas
      this.generatedXML = xmlContent;
      
    } catch (error) {
      this.reportGenerator.addTestResult('XML Generation', false, { error: error.message });
      console.error('‚ùå Eroare la generarea XML:', error.message);
      throw error;
    }
  }

  /**
   * PregƒÉte»ôte datele facturii pentru XML generator
   */
  async prepareInvoiceDataForXML(invoice) {
    // Preia datele tenantului
    const tenant = invoice.tenant;
    
    // PregƒÉte»ôte datele companiei (supplier)
    const companyData = {
      name: tenant.companyName || 'Test Company SRL',
      taxId: tenant.companyTaxId || 'RO12345678',
      address: tenant.address || 'Strada Test 123, Bucure»ôti',
      city: tenant.companyCity || 'Bucure»ôti',
      postalCode: tenant.companyPostalCode || '010001',
      country: tenant.companyCountry || 'RO',
      email: tenant.companyEmail || 'test@company.com',
      phone: tenant.phone || '+40 123 456 789'
    };
    
    // PregƒÉte»ôte datele clientului
    const customerData = {
      name: invoice.customer_name || 'Test Customer SRL',
      taxId: invoice.customer_tax_id || 'RO00000000',
      address: invoice.customer_address || 'Strada Client 456, Bucure»ôti',
      email: invoice.customer_email || 'client@test.com'
    };
    
    // PregƒÉte»ôte items-urile
    const items = (invoice.items || []).map((item, index) => ({
      id: item.id || index + 1,
      description: item.description || item.product_name || 'Produs de test',
      quantity: item.quantity || 1,
      unitOfMeasure: item.unit_of_measure || 'C62',
      unitPrice: item.unit_price || item.price || 100,
      totalPrice: item.total_price || item.quantity * item.unit_price || 100,
      vatRate: item.vat_rate || item.tax_rate || 19,
      vatAmount: item.vat_amount || item.tax_amount || 19,
      currency: item.currency || invoice.currency || 'RON'
    }));
    
    // CalculeazƒÉ totalurile
    const subtotal = invoice.subtotal || invoice.total_amount - (invoice.tax_amount || 0) || 100;
    const vatTotal = invoice.tax_amount || invoice.vat_amount || 19;
    const grandTotal = invoice.total_amount || invoice.grand_total || 119;
    
    return {
      invoice: {
        ...invoice,
        totals: {
          subtotal,
          vatTotal,
          grandTotal,
          currency: invoice.currency || 'RON'
        }
      },
      items,
      customer: customerData,
      company: companyData
    };
  }

  /**
   * SalveazƒÉ XML-ul pentru inspec»õie
   */
  async saveXMLForInspection(xmlContent, invoice) {
    try {
      await fs.mkdir(TEST_CONFIG.RESULTS_DIR, { recursive: true });
      
      const filename = `invoice-${invoice.id || 'test'}-${Date.now()}.xml`;
      const filepath = path.join(TEST_CONFIG.RESULTS_DIR, filename);
      
      await fs.writeFile(filepath, xmlContent);
      console.log(`   XML salvat: ${filepath}`);
      
    } catch (error) {
      console.warn('‚ö†Ô∏è  Nu s-a putut salva XML-ul:', error.message);
    }
  }

  /**
   * TesteazƒÉ autentificarea ANAF
   */
  async testANAFAuthentication() {
    console.log('\nüîê Testare autentificare ANAF...');
    
    try {
      // VerificƒÉ dacƒÉ utilizatorul este autentificat
      const isAuthenticated = await this.anafOAuth.isAuthenticated(TEST_CONFIG.TEST_TENANT_ID);
      
      if (!isAuthenticated) {
        console.log('‚ö†Ô∏è  Utilizatorul nu este autentificat cu ANAF');
        console.log('   Pentru test complet, autentificƒÉ-te prin interfa»õa web');
        
        this.reportGenerator.addTestResult('ANAF Authentication', false, {
          message: 'Utilizatorul nu este autentificat cu ANAF'
        });
        
        return false;
      }
      
      console.log('‚úÖ Utilizatorul este autentificat cu ANAF');
      
      this.reportGenerator.addTestResult('ANAF Authentication', true, {
        message: 'Utilizatorul este autentificat cu ANAF'
      });
      
      return true;
      
    } catch (error) {
      this.reportGenerator.addTestResult('ANAF Authentication', false, { error: error.message });
      console.error('‚ùå Eroare la verificarea autentificƒÉrii:', error.message);
      return false;
    }
  }

  /**
   * TesteazƒÉ trimiterea facturii la ANAF
   */
  async testInvoiceSubmission(invoice) {
    console.log('\nüì§ Testare trimitere facturƒÉ la ANAF...');
    
    try {
      // Folose»ôte ANAFIntegration pentru a trimite factura
      const result = await this.anafIntegration.submitInvoice(invoice.id, TEST_CONFIG.TEST_TENANT_ID, {
        submissionType: 'test',
        language: 'ro'
      });
      
      if (result.success) {
        console.log('‚úÖ Factura a fost trimisƒÉ cu succes la ANAF');
        console.log(`   Submission ID: ${result.submissionId}`);
        console.log(`   Status: ${result.status}`);
        console.log(`   Mesaj: ${result.message}`);
        
        this.reportGenerator.addTestResult('Invoice Submission', true, {
          submissionId: result.submissionId,
          status: result.status,
          message: result.message
        });
        
        // StocheazƒÉ submission ID pentru verificarea statusului
        this.submissionId = result.submissionId;
        
      } else {
        throw new Error(result.message || 'Trimiterea a e»ôuat');
      }
      
    } catch (error) {
      this.reportGenerator.addTestResult('Invoice Submission', false, { error: error.message });
      console.error('‚ùå Eroare la trimiterea facturii:', error.message);
      
      // Pentru test, continuƒÉ chiar dacƒÉ trimiterea a e»ôuat
      console.log('‚ö†Ô∏è  Testul continuƒÉ fƒÉrƒÉ trimiterea efectivƒÉ la ANAF');
    }
  }

  /**
   * TesteazƒÉ verificarea statusului
   */
  async testStatusChecking(invoice) {
    console.log('\nüîç Testare verificare status...');
    
    if (!this.submissionId) {
      console.log('‚ö†Ô∏è  Nu existƒÉ submission ID pentru verificarea statusului');
      this.reportGenerator.addTestResult('Status Checking', false, {
        message: 'Nu existƒÉ submission ID pentru verificarea statusului'
      });
      return;
    }
    
    try {
      // Folose»ôte ANAFIntegration pentru a verifica statusul
      const statusResult = await this.anafIntegration.getInvoiceStatus(invoice.id, TEST_CONFIG.TEST_TENANT_ID);
      
      if (statusResult.success) {
        console.log('‚úÖ Status verificat cu succes');
        console.log(`   Status: ${statusResult.status}`);
        console.log(`   Mesaj: ${statusResult.message}`);
        
        this.reportGenerator.addTestResult('Status Checking', true, {
          status: statusResult.status,
          message: statusResult.message
        });
        
      } else {
        throw new Error(statusResult.message || 'Verificarea statusului a e»ôuat');
      }
      
    } catch (error) {
      this.reportGenerator.addTestResult('Status Checking', false, { error: error.message });
      console.error('‚ùå Eroare la verificarea statusului:', error.message);
    }
  }

  /**
   * GenereazƒÉ rapoarte finale
   */
  async generateReports() {
    console.log('\nüìä Generare rapoarte finale...');
    
    this.reportGenerator.finalize();
    this.reportGenerator.generateConsoleReport();
    await this.reportGenerator.saveReport();
  }
}

/**
 * Generator de rapoarte pentru test
 */
class TestReportGenerator {
  constructor() {
    this.results = {
      startTime: new Date().toISOString(),
      endTime: null,
      totalTests: 0,
      passedTests: 0,
      failedTests: 0,
      testResults: [],
      summary: {
        databaseConnection: { success: false, message: '' },
        invoiceRetrieval: { success: false, message: '' },
        xmlGeneration: { success: false, message: '' },
        anafAuthentication: { success: false, message: '' },
        invoiceSubmission: { success: false, message: '' },
        statusChecking: { success: false, message: '' },
        overallSuccess: false
      }
    };
  }

  addTestResult(testName, success, details = {}) {
    const result = {
      testName,
      success,
      timestamp: new Date().toISOString(),
      details
    };
    
    this.results.testResults.push(result);
    this.results.totalTests++;
    
    if (success) {
      this.results.passedTests++;
    } else {
      this.results.failedTests++;
    }
  }

  updateSummary(section, data) {
    this.results.summary[section] = { ...this.results.summary[section], ...data };
  }

  finalize() {
    this.results.endTime = new Date().toISOString();
    this.results.summary.overallSuccess = this.results.failedTests === 0;
    
    const start = new Date(this.results.startTime);
    const end = new Date(this.results.endTime);
    this.results.duration = end - start;
  }

  generateConsoleReport() {
    console.log('\n' + '='.repeat(80));
    console.log('üìä Raport Test ANAF e-Factura Integrat');
    console.log('='.repeat(80));
    
    console.log(`\n‚è±Ô∏è  Durata test: ${this.results.duration}ms`);
    console.log(`üìà Total teste: ${this.results.totalTests}`);
    console.log(`‚úÖ Reu»ôite: ${this.results.passedTests}`);
    console.log(`‚ùå E»ôuate: ${this.results.failedTests}`);
    console.log(`üéØ Rata de succes: ${((this.results.passedTests / this.results.totalTests) * 100).toFixed(1)}%`);
    
    console.log('\nüìã Rezumat:');
    console.log(`   üóÑÔ∏è  Conexiune bazƒÉ de date: ${this.results.summary.databaseConnection.success ? '‚úÖ' : '‚ùå'} ${this.results.summary.databaseConnection.message}`);
    console.log(`   üìÑ Preluare facturƒÉ: ${this.results.summary.invoiceRetrieval.success ? '‚úÖ' : '‚ùå'} ${this.results.summary.invoiceRetrieval.message}`);
    console.log(`   üîß Generare XML: ${this.results.summary.xmlGeneration.success ? '‚úÖ' : '‚ùå'} ${this.results.summary.xmlGeneration.message}`);
    console.log(`   üîê Autentificare ANAF: ${this.results.summary.anafAuthentication.success ? '‚úÖ' : '‚ùå'} ${this.results.summary.anafAuthentication.message}`);
    console.log(`   üì§ Trimitere facturƒÉ: ${this.results.summary.invoiceSubmission.success ? '‚úÖ' : '‚ùå'} ${this.results.summary.invoiceSubmission.message}`);
    console.log(`   üîç Verificare status: ${this.results.summary.statusChecking.success ? '‚úÖ' : '‚ùå'} ${this.results.summary.statusChecking.message}`);
    
    console.log('\nüìù Rezultate detaliate:');
    this.results.testResults.forEach((result, index) => {
      const status = result.success ? '‚úÖ' : '‚ùå';
      console.log(`   ${index + 1}. ${status} ${result.testName}`);
      if (result.details.message) {
        console.log(`      ${result.details.message}`);
      }
    });
    
    console.log('\n' + '='.repeat(80));
    
    if (this.results.summary.overallSuccess) {
      console.log('üéâ Toate testele au trecut! Integrarea ANAF e-Factura func»õioneazƒÉ corect.');
    } else {
      console.log('‚ö†Ô∏è  Unele teste au e»ôuat. Te rugƒÉm sƒÉ verifici rezultatele »ôi sƒÉ corectezi problemele.');
    }
    console.log('='.repeat(80) + '\n');
  }

  async saveReport() {
    try {
      await fs.mkdir(TEST_CONFIG.RESULTS_DIR, { recursive: true });
      
      const reportPath = path.join(TEST_CONFIG.RESULTS_DIR, TEST_CONFIG.REPORT_FILE);
      await fs.writeFile(reportPath, JSON.stringify(this.results, null, 2));
      
      console.log(`\nüíæ Raport salvat: ${reportPath}`);
    } catch (error) {
      console.error('‚ùå Nu s-a putut salva raportul:', error.message);
    }
  }
}

/**
 * Func»õia principalƒÉ
 */
async function main() {
  console.log('üéØ ANAF e-Factura Test Integrat');
  console.log('=================================');
  console.log('Acest test folose»ôte serviciile reale din aplica»õie:');
  console.log('‚Ä¢ Preia facturƒÉ din baza de date (tabelul invoices)');
  console.log('‚Ä¢ GenereazƒÉ XML folosind ANAFXMLGenerator');
  console.log('‚Ä¢ Trimite factura folosind ANAFIntegration');
  console.log('‚Ä¢ VerificƒÉ rƒÉspunsul ANAF »ôi statusul');
  console.log('');
  
  const testRunner = new ANAFIntegratedTestRunner();
  await testRunner.runAllTests();
}

// RuleazƒÉ testul
if (require.main === module) {
  main().catch(error => {
    console.error('üí• Eroare fatalƒÉ:', error);
    process.exit(1);
  });
}

module.exports = {
  ANAFIntegratedTestRunner,
  TestReportGenerator,
  TEST_CONFIG
};
